# We set the language to python, so that we can more easily specify our
# build matrix.  We simply apt install the compiled dependencies.
language: python

matrix:
  include:
    # GCC 4.8
    - os: linux
      dist: trusty
      sudo: false
      addons:
        apt:
          packages:
            - build-essential
            - gcc
            - g++
            - gfortran
            - autoconf
            - automake
            - m4
            - libtool
            - libhdf5-dev
            - libmpich-dev
            - fftw3-dev
            - libatlas-base-dev
            - pkg-config
      env:
        - MATRIX_EVAL="CC=$(which gcc) && CXX=$(which g++) && FC=$(which gfortran) && MPICH_CC=${CC} && MPICH_CXX=${CXX} && MPICH_FC=${FC}"
    # GCC 4.9
    - os: linux
      dist: trusty
      sudo: false
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - build-essential
            - gcc-4.9
            - g++-4.9
            - gfortran-4.9
            - autoconf
            - automake
            - m4
            - libtool
            - libhdf5-dev
            - libmpich-dev
            - fftw3-dev
            - libatlas-base-dev
            - pkg-config
      env:
        - MATRIX_EVAL="CC=$(which gcc-4.9) && CXX=$(which g++-4.9) && FC=$(which gfortran-4.9) && MPICH_CC=${CC} && MPICH_CXX=${CXX} && MPICH_FC=${FC}"
    # GCC 5
    - os: linux
      dist: trusty
      sudo: false
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - build-essential
            - gcc-5
            - g++-5
            - gfortran-5
            - autoconf
            - automake
            - m4
            - libtool
            - libhdf5-dev
            - libmpich-dev
            - fftw3-dev
            - libatlas-base-dev
            - pkg-config
      env:
        - MATRIX_EVAL="CC=$(which gcc-5) && CXX=$(which g++-5) && FC=$(which gfortran-5) && MPICH_CC=${CC} && MPICH_CXX=${CXX} && MPICH_FC=${FC}"
    # GCC 6
    - os: linux
      dist: trusty
      sudo: false
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - build-essential
            - gcc-6
            - g++-6
            - gfortran-6
            - autoconf
            - automake
            - m4
            - libtool
            - libhdf5-dev
            - libmpich-dev
            - fftw3-dev
            - libatlas-base-dev
            - pkg-config
      env:
        - MATRIX_EVAL="CC=$(which gcc-6) && CXX=$(which g++-6) && FC=$(which gfortran-6) && MPICH_CC=${CC} && MPICH_CXX=${CXX} && MPICH_FC=${FC}"
    # GCC 7
    - os: linux
      dist: trusty
      sudo: false
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - build-essential
            - gcc-7
            - g++-7
            - gfortran-7
            - autoconf
            - automake
            - m4
            - libtool
            - libhdf5-dev
            - libmpich-dev
            - fftw3-dev
            - libatlas-base-dev
            - pkg-config
      env:
        - MATRIX_EVAL="CC=$(which gcc-7) && CXX=$(which g++-7) && FC=$(which gfortran-7) && MPICH_CC=${CC} && MPICH_CXX=${CXX} && MPICH_FC=${FC}"

# The versions to test
python:
    - 3.6

# Set up MPI and mpi4py

before_install:
    - wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
    - bash miniconda.sh -b -p $HOME/miniconda
    - export PATH="$HOME/miniconda/bin:$PATH"
    - hash -r
    - conda config --set always_yes yes --set changeps1 no
    - conda update -q conda
    # Useful for debugging any issues with conda
    - conda info -a
    - conda install -c conda-forge numpy scipy matplotlib healpy pyephem pip
    - pip install mpi4py
    - eval "${MATRIX_EVAL}"
    # Information about compilers
    - ${CC} -dumpversion
    - ${CXX} -dumpversion
    - ${FC} -dumpversion
    - if [ ! -z "$(which mpicc)" ]; then mpicc --version ; else echo "No mpicc" ; fi
    - if [ ! -z "$(which mpic++)" ]; then mpic++ --version ; else echo "No mpic++" ; fi
    - if [ ! -z "$(which mpicxx)" ]; then mpicxx --version ; else echo "No mpicxx" ; fi

# Skip this

install:
    - ./autogen.sh
    - export CFLAGS="-O3 -g -fPIC -pthread -std=c99"
    - export CXXFLAGS="-O3 -g -fPIC -pthread"
    - ./configure --prefix=$HOME/miniconda
    - make
    - make install

# Configure, build, and run tests

script:
    - python -c "import toast; toast.test()"
